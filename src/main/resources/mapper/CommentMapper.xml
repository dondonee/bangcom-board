<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.knou.board.repository.mybatis.CommentMapper">

    <resultMap id="memberMap" type="Member">
        <result property="userNo" column="user_no"/>
        <result property="nickname" column="nickname"/>
        <result property="imageName" column="image_name"/>
        <result property="bio" column="bio"/>
        <result property="transferred" column="transferred"/>
        <result property="grade" column="grade" typeHandler="com.knou.board.domain.member.Member$Grade$TypeHandler"/>
        <result property="authority" column="authority"
                typeHandler="com.knou.board.domain.member.Member$Authority$TypeHandler"/>
        <result property="region" column="region" typeHandler="com.knou.board.domain.member.Member$Region$TypeHandler"/>
        <result property="joinedDate" column="joined_date"/>
        <result property="updatedDate" column="updated_date"/>
    </resultMap>
    <resultMap id="commentMap" type="Comment">
        <id property="id" column="comment_id"/>
        <result property="postId" column="post_id"/>
        <result property="content" column="content"/>
        <result property="createdDate" column="created_date"/>
        <result property="modifiedDate" column="modified_date"/>
        <collection property="writer" resultMap="memberMap"/>
    </resultMap>


    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post_comment (post_id, writer_id, content, created_date)
        VALUES (#{postId}, #{writer.userNo}, #{content}, #{createdDate})
    </insert>

    <select id="selectByPostId" resultMap="commentMap">
        SELECT *
        FROM post_comment
                 LEFT JOIN member_profile ON post_comment.writer_id = member_profile.user_no
        WHERE post_comment.post_id = #{postId}
        ORDER BY post_comment.comment_id DESC
    </select>

    <select id="countTotalSelectedByPostId" resultType="long">
        SELECT count(*)
        FROM post_comment
        WHERE post_comment.post_id = #{postId}
    </select>
</mapper>