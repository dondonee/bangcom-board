<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.knou.board.repository.mybatis.CommentMapper">

    <resultMap id="commentMap" type="Comment">
        <id property="id" column="comment_id"/>
        <result property="postId" column="post_id"/>
        <result property="content" column="content"/>
        <result property="groupNo" column="group_no"/>
        <result property="orderNo" column="order_no"/>
        <result property="createdDate" column="created_date"/>
        <result property="modifiedDate" column="modified_date"/>
        <association property="writer" column="writer_id" >
            <result property="userNo" column="user_no"/>
            <result property="nickname" column="nickname"/>
            <result property="imageName" column="image_name"/>
            <result property="bio" column="bio"/>
            <result property="transferred" column="transferred"/>
            <result property="grade" column="grade"
                    typeHandler="com.knou.board.domain.member.Member$Grade$TypeHandler"/>
            <result property="authority" column="authority"
                    typeHandler="com.knou.board.domain.member.Member$Authority$TypeHandler"/>
            <result property="region" column="region"
                    typeHandler="com.knou.board.domain.member.Member$Region$TypeHandler"/>
            <result property="joinedDate" column="joined_date"/>
            <result property="updatedDate" column="updated_date"/>
        </association>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO post_comment (post_id, writer_id, content, parent_id, group_no, created_date, order_no)
        VALUES (#{postId}, #{writer.userNo}, #{content}, #{parentComment.commentId}, #{groupNo}, #{createdDate},
        <if test="parentComment == null">
            (SELECT MAX(order_no) + 1
            FROM post_comment
            WHERE post_id = #{postId})
        </if>
        <if test="parentComment != null">
            (SELECT MAX(order_no) + 1
            FROM post_comment
            WHERE post_id = #{postId} and group_no = #{groupNo})
        </if>
        )
    </insert>

    <select id="selectByPostId" resultMap="commentMap">
        SELECT *
        FROM post_comment p
                 JOIN member_profile m1
                      ON p.writer_id = m1.user_no
    </select>

    <select id="countTotalSelectedByPostId" resultType="long">
        SELECT count(*)
        FROM post_comment
        WHERE post_comment.post_id = #{postId}
    </select>

    <update id="updateOrderNo">
        UPDATE post_comment
        SET order_no = order_no + 1
        WHERE post_id = #{postId}
          and order_no > #{orderNo}
    </update>
</mapper>